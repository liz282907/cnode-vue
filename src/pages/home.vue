<template>
  <div>
      <nav-head></nav-head>
      <div class="nav-bar">
        <span><i class="iconfont nav-img" @click='show=true'>&#xe745;</i></span>
        <h1>{{title}}</h1>

      </div>
      <ul>
        <li v-for="item in postList" :key="item.id">
          <router-link :to="{ name: 'topic', params: { id: item.id }}">
          <card :title="item.title" :tagName="item.tagName" :isTop="item.top" :imgSrc="item.author.avatar_url"
                :commentCount.number="item.reply_count"
                :clickCount.number="item.visit_count"
                :creator="item.author.loginname"
                :createTime="item.create_at"
                :updateTime="item.last_reply_at"

          ></card>
          </router-link>
        </li>
      </ul>
      <slide-card :show='show' :cancel='handleModal.bind(this,false)'></slide-card>


  </div>

</template>
<script>
import moment from 'moment';
import NavHead from '../components/header';
import Card from '../components/card';
import SlideCard from '../components/slide-card.vue'

import { throtte,isScrollDown,check_if_needs_more_content,isObjEmpty } from '../utils/util';
import { getTabName } from '../constants/config';

moment.locale("zh-cn");

const limit = 10;
let responseDict = {};

// const postList = [
//   {
//     // customStyle:,
//     top: false,
//     title: "光棍节程序员闯关",
//     tagName: "置顶",
//     // imgSrc: "./assets/images/logo.png",
//     reply_count: 26,
//     visit_count: 2552,
//     good: false,
//     author: {
//       loginname:"nswbmw",
//       avatar_url: "https://avatars.githubusercontent.com/u/4279697?v=3&s=120"
//     },
//     create_at: "2016-09-27 15:53:31",
//     last_reply_at: moment("2016-11-12T07:12:05.514Z").fromNow(),
//     isTop: false
//   }
// ]

export default {
    name:'Home',
    components: {
        'nav-head': NavHead,
        'card': Card,
        'slide-card': SlideCard,

    },
    // props: ['tab'],
    data() {
        return {
            postList: [],
            page: 1,
            // initTop: document.documentElement.scrollTop,
            show: false,
            showModal: false,
            // fromRoute:'',
            tab: 'all'
        }
    },
    computed:{
      title(){
        return getTabName(this.tab);
      }
    },
    watch: {
        '$route'(to,from) {
            //监听tab导致的路由变动
            if(to.query && to.query.tab){
              this.tab = to.query.tab;
              this.show = false;
              //reset localStorage
              this.reset();
              this.fetchPage(this.page);
            }
        }
    },

    //在route里面赋值，为create里面的数据到底是获取还是用缓存数据做区分
    beforeRouteEnter(to, from, next) {
        debugger;
        //从详情页回来
        if (from.fullPath.indexOf('topic') !== -1) {
            next(vm=>{
                vm.fromRoute = from.fullPath;
            });
          }
        else
          next(vm=> vm.fromRoute = '');

    },
    beforeRouteLeave(to,from,next){
      //记录上次的scrollTop
      if(to.name==='topic'){
        const scrollTop = document.body.scrollTop||document.documentElement.scrollTop;
        localStorage.setItem('scrollTop',JSON.stringify(scrollTop));
        localStorage.setItem('tab',JSON.stringify(this.tab));
        localStorage.setItem('postList',JSON.stringify(this.postList));
      }

      next();
    },


    beforeCreate() {
    },

    created() {


    },
    mounted() {
        //从详情页返回
        if(!localStorage.getItem('postList')) this.fetchPage(this.page);
        else
        {

          // this.postList = Object.keys(responseDict).map(index=>responseDict[index]);

          this.postList = JSON.parse(localStorage.getItem('postList'));
          window.scroll(0,JSON.parse(localStorage.getItem('scrollTop')));
          // this.$nextTick(()=> window.scroll(0,JSON.parse(localStorage.getItem('scrollTop'))));
        }

        this.infiniteScroll = throtte(this.fetchWhenScroll.bind(this), 300);
          // this.infiniteScroll = this.infiniteScroll.bind(this);
        window.addEventListener("scroll", this.infiniteScroll);
    },
    beforeUpdate(){
      console.log(arguments);
    },
    beforeDestroy() {
        window.removeEventListener("scroll", this.infiniteScroll);
    },
    destroyed() {
        console.log("destroyed");
    },

    methods: {

        reset() {
            //路由回退后清空缓存数据。
            responseDict = {};
            this.page = 1;
            this.postList = [];
            localStorage.removeItem('postList');
            localStorage.removeItem('scrollTop');
            localStorage.removeItem('tab');
        },

        // infiniteScroll(e){
        //     return throtte(this.fetchWhenScroll.bind(this),1000);
        // },
        getTransformedResponse(prevResponse) {
            return prevResponse.data.map(item => {
                // debugger;
                item.create_at = moment(item.create_at).format("YYYY-MM-DD HH:mm");
                item.last_reply_at = moment(item.last_reply_at).fromNow();
                item.tagName = item.top?'置顶':getTabName(item.tab);

                return item;
            })
        },


        fetchWhenScroll() {
            /*
                  let isDown = isScrollDown(this.initTop,(curTop)=>{
                    this.initTop = curTop;
                  });
                  isDown? this.page++ : this.page--;
                  this.fetchPage(this.page);
            */
            if (check_if_needs_more_content()) {
                // console.log("--------------page-----------",this.page);
                this.fetchPage(this.page);
                this.page++;
            }
        },

        fetchPage(page) {
            if (responseDict[page]) return;

            axios.get('https://cnodejs.org/api/v1/topics', {
                    params: {
                        page,
                        tab: this.tab,
                        limit
                    }
                })
                .then(response => {
                    if (response.data) {
                        const appendedList = this.getTransformedResponse(response.data);
                        responseDict[page] = appendedList;
                        this.postList = [...this.postList, ...appendedList];
                    }

                })
                .catch(err => console.log(err));
        },
        handleModal(value) {
            this.show = value;
        }
    }

};
</script>

<style>

</style>
